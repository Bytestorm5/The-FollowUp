name: Run Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: '20 */2 * * *' # every 2 hours at :20 UTC

jobs:
  run-pipeline:
    name: Run pipeline on main
    runs-on: ubuntu-latest
    env:
      MONGO_URI: ${{secrets.MONGO_URI}}
      OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.2'

      - name: Create virtualenv and install requirements
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f service/requirements.txt ]; then pip install -r service/requirements.txt; fi
          python -m spacy download en_core_web_sm

      - name: Run pipeline
        env:
          PYTHONUNBUFFERED: 1
        run: |
          source .venv/bin/activate
          playwright install
          python -u service/scripts/run_pipeline.py
